# firewall_honeypot.py

import logging
import socket
import threading
from netfilterqueue import NetfilterQueue
from scapy.all import IP, TCP

# Configure logging
logging.basicConfig(
    filename='honeypot.log',
    level=logging.INFO,
    format='%(asctime)s [HONEYPOT] %(message)s'
)

# Configuration
BLOCKED_IP = "192.168.50.100"    # Only block this IP
SSH_PORT = 22                    # Real SSH port
HONEYPOT_PORT = 22               # Weâ€™ll mimic it using scapy/netfilter
HONEYPOT_BANNER = b"SSH-2.0-OpenSSH_7.4\r\n"  # Fake SSH banner

def process_packet(packet):
    payload = packet.get_payload()
    pkt = IP(payload)

    if pkt.haslayer(TCP):
        src_ip = pkt[IP].src
        dst_port = pkt[TCP].dport

        print(f"[+] Attempt from {src_ip} to port {dst_port}")

        if src_ip == BLOCKED_IP and dst_port == SSH_PORT:
            # Drop real SSH packet from blocked IP
            print(f"[HONEYPOT] Blocked & logged attempt from {src_ip} to SSH")
            logging.info(f"Blocked SSH attempt from {src_ip}")
            packet.drop()
        else:
            packet.accept()
    else:
        packet.accept()

def start_honeypot():
    server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    server.bind(("0.0.0.0", HONEYPOT_PORT))
    server.listen(5)
    print(f"[HONEYPOT] Fake SSH server running on port {HONEYPOT_PORT}")

    while True:
        client, addr = server.accept()
        ip = addr[0]
        if ip == BLOCKED_IP:
            print(f"[HONEYPOT] Connection from blocked IP {ip}")
            client.send(HONEYPOT_BANNER)
            data = client.recv(1024)
            logging.info(f"Captured interaction from {ip}: {data.decode(errors='ignore')}")
            client.close()
        else:
            # Close connections from allowed IPs to avoid interference
            client.close()

# Run honeypot in background
t = threading.Thread(target=start_honeypot, daemon=True)
t.start()

# Setup NetfilterQueue
nfqueue = NetfilterQueue()
nfqueue.bind(1, process_packet)

print("[*] Firewall & Honeypot running. Waiting for packets...")
try:
    nfqueue.run()
except KeyboardInterrupt:
    print("\n[*] Stopping firewall.")
    nfqueue.unbind()
