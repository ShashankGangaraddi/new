# firewall_honeypot.py
import logging
from netfilterqueue import NetfilterQueue
from scapy.all import IP, TCP

# Configure logging
logging.basicConfig(
    filename='honeypot.log',
    level=logging.INFO,
    format='%(asctime)s [HONEYPOT] %(message)s'
)

# Configuration
ALLOWED_IP = "192.168.50.2"    # Use a fake IP so that all others trigger honeypot
ALLOWED_PORT = 22              # Only allow SSH on port 22 from the allowed IP

def process_packet(packet):
    payload = packet.get_payload()
    pkt = IP(payload)

    if pkt.haslayer(TCP):
        src_ip = pkt[IP].src
        dst_port = pkt[TCP].dport

        if src_ip == ALLOWED_IP and dst_port == ALLOWED_PORT:
            print(f"[FIREWALL] Allowed: {src_ip}:{dst_port}")
            packet.accept()
        else:
            print(f"[HONEYPOT] Logging attempt from {src_ip}:{dst_port}")
            logging.info(f"Detected unauthorized access from {src_ip} to port {dst_port}")
            packet.drop()
    else:
        packet.accept()

nfqueue = NetfilterQueue()
nfqueue.bind(1, process_packet)

print("[*] Firewall & Honeypot running. Waiting for packets...")
try:
    nfqueue.run()
except KeyboardInterrupt:
    print("\n[*] Stopping firewall.")
    nfqueue.unbind()
