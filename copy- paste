from netfilterqueue import NetfilterQueue
from scapy.all import IP, TCP, send, Raw
import logging
import os

BLOCKED_IP = "192.168.50.100"

# Set up logging
logging.basicConfig(filename="honeypot.log", level=logging.INFO, format="%(asctime)s [FAKE SSH] %(message)s")

def process_packet(packet):
    pkt = IP(packet.get_payload())
    
    if pkt.haslayer(TCP):
        src_ip = pkt[IP].src
        dst_port = pkt[TCP].dport

        # Show all traffic live
        print(f"[ACCESS] {src_ip} --> port {dst_port}")

        if dst_port == 22 and src_ip == BLOCKED_IP:
            # Log to honeypot
            logging.info(f"Detected SSH access from {src_ip}")

            # Respond with fake SSH banner to make it look real
            if pkt[TCP].flags == "S":
                ip_resp = IP(dst=src_ip, src=pkt[IP].dst)
                tcp_resp = TCP(sport=22, dport=pkt[TCP].sport, seq=1000, ack=pkt[TCP].seq + 1, flags="SA")
                send(ip_resp/tcp_resp, verbose=0)

            elif pkt[TCP].flags == "A":
                ip_resp = IP(dst=src_ip, src=pkt[IP].dst)
                tcp_resp = TCP(sport=22, dport=pkt[TCP].sport, seq=1001, ack=pkt[TCP].seq + 1, flags="PA")
                banner = Raw(load="SSH-2.0-OpenSSH_8.9p1 Ubuntu-3ubuntu0.1\r\n")
                send(ip_resp/tcp_resp/banner, verbose=0)

            packet.drop()
            return

    packet.accept()

print("[*] Firewall & Honeypot running. Waiting for packets...")

nfqueue = NetfilterQueue()
nfqueue.bind(0, process_packet)

try:
    nfqueue.run()
except KeyboardInterrupt:
    print("\n[!] Stopping Firewall & Cleaning up...")
    nfqueue.unbind()
    os.system("sudo iptables -F")
